"use strict";angular.module("oisdn4App",["ngResource","ngTouch","ui.bootstrap","ui.router","highcharts-ng","geolocation","ngDialog","uiGmapgoogle-maps","oauth.io"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"views/main.html"}).state("account",{url:"/:id/account",templateUrl:"views/account.html",controller:"AccountCtrl"})}]).config(["uiGmapGoogleMapApiProvider",function(a){a.configure({v:"3.17"})}]).config(["OAuthProvider",function(a){a.setPublicKey("Zcy9H_R3eAhBKyDr1sO_db3wLcA"),a.setHandler("strava",["OAuthData","StravaApi",function(a,b){b.qAPI.resolve(a.result)}])}]).run(["$rootScope","users","geolocation","ehrApi","$state","StravaApi",function(a,b,c,d,e,f){angular.extend(a,{uporabniki:b,$state:e,strava:f}),a.generateUsers=function(){a.loading=!0,d.generateUsers().then(function(){a.loading=!1,e.reload()})},a.$on("ngDialog.opened",function(){c.getLocation().then(function(b){a.lokacija={latitude:b.coords.latitude,longitude:b.coords.longitude}})})}]),angular.module("oisdn4App").controller("AccountCtrl",["$scope","grafi","users","$stateParams","ehrApi","$filter","StravaApi",function(a,b,c,d,e,f,g){a.uporabnik=c[d.id],a.grafi=angular.copy(b),a.maxPritisk=0,a.starost=(new Date).getFullYear()-new Date(a.uporabnik.datumRojstva).getFullYear(),e.doAQL(a.uporabnik).then(function(b){var c=b.data.resultSet[0];a.itm=c.Body_weight.magnitude/Math.pow(c.Body_Height_Length.magnitude/100,2)}),e.getBP(a.uporabnik).then(function(b){angular.forEach(b.data.reverse(),function(b){a.maxPritisk=Math.max(a.maxPritisk,b.systolic),a.grafi.tlak.series[0].data.push({datum:f("date")(b.time,"dd. MM. yyyy"),x:b.diastolic,y:b.systolic})})}),g.me.promise.then(function(b){angular.extend(a,b)})}]),angular.module("oisdn4App").service("ehrApi",["$http","$q","users",function(a,b,c){function d(a,b,c,d,e,f){return{"ctx/language":"en","ctx/territory":"SI","ctx/time":a,"vital_signs/height_length/any_event/body_height_length":b,"vital_signs/body_weight/any_event/body_weight":c,"vital_signs/body_temperature/any_event/temperature|magnitude":d,"vital_signs/body_temperature/any_event/temperature|unit":"°C","vital_signs/blood_pressure/any_event/systolic":e,"vital_signs/blood_pressure/any_event/diastolic":f}}function e(c){var e=[];e.push(a({url:f+"/demographics/party",method:"POST",data:{firstNames:c.ime,lastNames:c.priimek,dateOfBirth:c.datumRojstva,partyAdditionalInfo:[{key:"ehrId",value:c.ehrId}]}}));for(var g=new Date,h=0;h<c.meritve.height.length;h++)g.setFullYear(2014-h),e.push(a({url:f+"/composition",method:"POST",params:{ehrId:c.ehrId,templateId:"Vital Signs",format:"FLAT",committer:"Milka Gorenjka"},data:d(g.toISOString(),c.meritve.height[h],c.meritve.weight[h],c.meritve.temperature[h],c.meritve.systolicBP[h],c.meritve.diastolicBP[h])}));return b.all(e)}var f="https://rest.ehrscape.com/rest/v1",g=b.defer(),h=function(a){return"select a_a/data[at0002]/events[at0003]/data[at0001]/items[at0004, 'Body weight']/value as Body_weight, a_b/data[at0001]/events[at0002]/data[at0003]/items[at0004, 'Body Height/Length']/value as Body_Height_Length from EHR[ehr_id/value = '"+a.ehrId+"'] contains COMPOSITION a contains ( OBSERVATION a_a[openEHR-EHR-OBSERVATION.body_weight.v1] and OBSERVATION a_b[openEHR-EHR-OBSERVATION.height.v1]) offset 0 limit 1"};a({url:f+"/session",method:"POST",params:{username:"ois.seminar",password:"ois4fri"}}).success(function(a){g.resolve(a.sessionId)}),this.doAQL=function(c){var d=b.defer();return g.promise.then(function(b){a.defaults.headers.common["Ehr-Session"]=b,a({url:f+"/query",params:{aql:h(c)},method:"GET"}).then(function(a){d.resolve(a)})}),d.promise},this.getBP=function(c){var d=b.defer();return g.promise.then(function(b){a.defaults.headers.common["Ehr-Session"]=b,a({url:f+"/view/"+c.ehrId+"/blood_pressure",method:"GET"}).then(function(a){d.resolve(a)})}),d.promise},this.generateUsers=function(){var d=b.defer(),h=[];return g.promise.then(function(g){a.defaults.headers.common["Ehr-Session"]=g,angular.forEach(c,function(b){h.push(a({url:f+"/ehr",method:"POST"}).success(function(a){b.ehrId=a.ehrId}))}),b.all(h).then(function(){angular.forEach(c,function(a){h.push(e(a))}),b.all(h).then(function(){d.resolve("Done!")})})}),d.promise}}]),angular.module("oisdn4App").constant("users",[{ime:"Ferdo",priimek:"Sidonija",slika:"images/franklin.9cfb7fae.png",datumRojstva:"1955-10-28T00:00",ehrId:"2a3148d9-5801-48cf-bc76-fa0fc6e8ae9c",meritve:{temperature:[36.8,37,36.5,38.2,37.3],systolicBP:[106,117,115,102,119],diastolicBP:[65,61,68,71,69],height:[185,186,186,185,186],weight:[77.5,78.3,79,80,83.2]}},{ime:"Mojmir",priimek:"Vekoslav",slika:"images/obama.a062c909.png",datumRojstva:"1986-11-21T00:00",ehrId:"cdd64978-016c-4ec2-9a87-3c35be22e46f",meritve:{temperature:[37.2,37.5,37,36.8,36.9],systolicBP:[129,135,139,130,132],diastolicBP:[75,90,78,89,85],height:[177,176,178,177,175],weight:[64,65.7,65.1,66.2,65.9]}},{ime:"Bogomil",priimek:"Borka",slika:"images/lincoln.f2a40800.png",datumRojstva:"1994-12-10T00:00",ehrId:"1fd6482f-955f-4f8d-b0a9-b3086f7bdb58",meritve:{temperature:[36.7,36.9,37.1,36.8,37.4],systolicBP:[141,135,147,150,142],diastolicBP:[79,89,91,92,87],height:[182,181,183,185,184],weight:[71.3,72.4,71.9,73,73.2]}}]),angular.module("oisdn4App").constant("grafi",{tlak:{options:{chart:{type:"scatter",zoomType:"xy"},plotOptions:{scatter:{tooltip:{headerFormat:"<b>Krvni tlak</b><br>",pointFormat:"<b>Sistolični:</b> {point.y} mm Hg<br> <b>Diastolični:</b> {point.x} mm Hg <br> <b>Datum: </b> {point.datum}"}}},xAxis:{min:40,max:100,title:{text:"Diastolični"},plotBands:[{color:"#dff0d8",from:60,to:80,zIndex:-19},{color:"#fcf8e3",from:80,to:90,zIndex:-17},{color:"#f2dede",from:90,to:100,zIndex:-15}]},yAxis:{title:{text:"Sistolični"},min:70,max:190,tickInterval:10,plotBands:[{color:"#d9edf7",from:70,to:90,zIndex:-20},{color:"#dff0d8",from:90,to:120,zIndex:-18},{color:"#fcf8e3",from:120,to:140,zIndex:-16},{color:"#f2dede",from:140,to:190,zIndex:-14}]}},series:[{name:"Krvni tlak",data:[],color:"#333"}],title:{text:null}}}),angular.module("oisdn4App").service("StravaApi",["$q","$http","OAuth",function(a,b,c){this.qAPI=a.defer();var d=a.defer();this.me=d,this.qAPI.promise.then(function(a){a.me().then(function(b){a.get("/v3/athletes/3292438/koms").then(function(a){d.resolve({me:b,koms:a})})})}),this.doAuth=function(){c.popup("strava")}}]);